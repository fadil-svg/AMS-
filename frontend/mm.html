    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let html5QrcodeScanner = null;
            let availableCameras = [];
            let currentCameraIndex = 0;
            let isScanning = false;
            let scanInProgress = false;
            let selectedAction = 'signin';
            
            // Initialize the app
            initializeApp();
            
            async function initializeApp() {
                try {
                    await initializeCameras();
                    await startScanner();
                } catch (error) {
                    handleCameraError(error);
                }
            }
            
            async function initializeCameras() {
                try {
                    availableCameras = await Html5Qrcode.getCameras();
                    if (availableCameras.length === 0) {
                        throw new Error('No cameras found on this device');
                    }
                    
                    // Enable camera toggle if multiple cameras available
                    const toggleBtn = document.getElementById('toggle-camera');
                    if (availableCameras.length > 1) {
                        toggleBtn.disabled = false;
                        toggleBtn.addEventListener('click', switchCamera);
                    }
                    
                } catch (error) {
                    throw new Error('Failed to access cameras: ' + error.message);
                }
            }
            
            async function startScanner() {
                if (html5QrcodeScanner) {
                    await stopScanner();
                }
                
                try {
                    html5QrcodeScanner = new Html5Qrcode("reader");
                    const cameraId = availableCameras[currentCameraIndex].id;
                    const qrConfig = { fps: 10, qrbox: { width: 350, height: 350 } };
                    
                    await html5QrcodeScanner.start(
                        cameraId,
                        qrConfig,
                        onScanSuccess,
                        onScanFailure
                    );
                    
                    isScanning = true;
                    hideError();
                    
                } catch (error) {
                    throw new Error('Failed to start scanner: ' + error.message);
                }
            }
            
            async function stopScanner() {
                if (html5QrcodeScanner && isScanning) {
                    try {
                        await html5QrcodeScanner.stop();
                        html5QrcodeScanner = null;
                        isScanning = false;
                    } catch (error) {
                        console.warn('Error stopping scanner:', error);
                    }
                }
            }
            
            async function switchCamera() {
                if (availableCameras.length <= 1) return;
                
                try {
                    await stopScanner();
                    currentCameraIndex = (currentCameraIndex + 1) % availableCameras.length;
                    await startScanner();
                } catch (error) {
                    handleCameraError(error);
                }
            }
            
            function onScanSuccess(decodedText, decodedResult) {
                // Prevent multiple rapid scans
                if (scanInProgress) return;
                scanInProgress = true;
                
                // Vibrate if supported
                if (navigator.vibrate) {
                    navigator.vibrate(200);
                }
                
                // Pause scanner temporarily
                if (html5QrcodeScanner && isScanning) {
                    html5QrcodeScanner.pause();
                }
                
                console.log(`QR Code detected: ${decodedText}`);
                
                // Validate QR code format (basic validation)
                if (!isValidQRCode(decodedText)) {
                    showToast('error');
                    resumeScanning();
                    return;
                }
                
                // Process the scan result
                processQRCode(decodedText);
            }
            
            function onScanFailure(error) {
                // Silently handle scan failures - they're normal during scanning
            }
            
            function isValidQRCode(code) {
                // Basic validation - adjust according to your QR code format
                return code && code.length >= 3 && code.length <= 50;
            }
            
            function processQRCode(code) {
                // Simulate API call with different scenarios
                const scenarios = ['success', 'signout', 'duplicate', 'error'];
                const randomScenario = scenarios[Math.floor(Math.random() * scenarios.length)];
                
                // Show appropriate toast
                showToast(randomScenario, code);
                
                // Resume scanning after delay
                setTimeout(() => {
                    resumeScanning();
                }, 3000);
            }
            
            function resumeScanning() {
                scanInProgress = false;
                if (html5QrcodeScanner && isScanning) {
                    try {
                        html5QrcodeScanner.resume();
                    } catch (error) {
                        console.warn('Error resuming scanner:', error);
                    }
                }
            }
            
            function handleCameraError(error) {
                console.error('Camera error:', error);
                showError(error.message);
                
                // Disable camera toggle on error
                const toggleBtn = document.getElementById('toggle-camera');
                toggleBtn.disabled = true;
            }
            
            function showError(message) {
                const errorDiv = document.getElementById('error-message');
                const errorText = document.getElementById('error-text');
                errorText.textContent = message;
                errorDiv.style.display = 'block';
            }
            
            function hideError() {
                const errorDiv = document.getElementById('error-message');
                errorDiv.style.display = 'none';
            }
            
            // Toast management (improved)
            function showToast(type, qrData = null) {
                const toast = document.getElementById('status-toast');
                const success = document.getElementById('status-success');
                const signout = document.getElementById('status-signout');
                const error = document.getElementById('status-error');
                const duplicate = document.getElementById('status-duplicate');
                
                // Hide all states first
                [success, signout, error, duplicate].forEach(el => el.classList.add('hidden'));
                
                // Set current time
                const now = new Date();
                const timeString = now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                
                // Show appropriate state
                switch(type) {
                    case 'success':
                        document.getElementById('user-name').textContent = getNameFromQR(qrData) || 'Jane Smith';
                        document.getElementById('sign-time').textContent = timeString;
                        success.classList.remove('hidden');
                        break;
                    case 'signout':
                        document.getElementById('signout-name').textContent = getNameFromQR(qrData) || 'Jane Smith';
                        signout.classList.remove('hidden');
                        break;
                    case 'error':
                        error.classList.remove('hidden');
                        break;
                    case 'duplicate':
                        document.getElementById('previous-time').textContent = '7:30 AM';
                        duplicate.classList.remove('hidden');
                        break;
                }
                
                // Show toast with animation
                toast.classList.remove('hidden');
                requestAnimationFrame(() => {
                    toast.classList.add('toast-enter');
                });
                
                // Hide toast after delay
                setTimeout(() => {
                    toast.classList.add('hidden');
                    toast.classList.remove('toast-enter');
                }, 3000);
            }
            
            function getNameFromQR(qrData) {
                // Extract name from QR code data if available
                // This is a placeholder - adjust according to your QR format
                return qrData ? `Student ${qrData.substring(0, 5)}` : null;
            }
            
            // Modal management (improved)
            const manualEntryBtn = document.getElementById('manual-entry-btn');
            const manualEntryModal = document.getElementById('manual-entry-modal');
            const closeModalBtn = document.getElementById('close-modal');
            
            manualEntryBtn.addEventListener('click', openModal);
            closeModalBtn.addEventListener('click', closeModal);
            
            // Close modal on outside click
            manualEntryModal.addEventListener('click', (e) => {
                if (e.target === manualEntryModal) {
                    closeModal();
                }
            });
            
            // Close modal on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !manualEntryModal.classList.contains('hidden')) {
                    closeModal();
                }
            });
            
            function openModal() {
                manualEntryModal.classList.remove('hidden');
                document.getElementById('student-id').focus();
            }
            
            function closeModal() {
                manualEntryModal.classList.add('hidden');
                document.getElementById('manual-form').reset();
                hideInputError();
                resetActionButtons();
            }
            
            // Action button toggle (improved)
            const signInBtn = document.getElementById('sign-in-btn');
            const signOutBtn = document.getElementById('sign-out-btn');
            
            signInBtn.addEventListener('click', () => selectAction('signin'));
            signOutBtn.addEventListener('click', () => selectAction('signout'));
            
            function selectAction(action) {
                selectedAction = action;
                
                if (action === 'signin') {
                    signInBtn.classList.remove('bg-gray-800', 'border-gray-700', 'text-gray-300');
                    signInBtn.classList.add('bg-primary/20', 'border-primary/40', 'text-primary');
                    
                    signOutBtn.classList.remove('bg-primary/20', 'border-primary/40', 'text-primary');
                    signOutBtn.classList.add('bg-gray-800', 'border-gray-700', 'text-gray-300');
                } else {
                    signOutBtn.classList.remove('bg-gray-800', 'border-gray-700', 'text-gray-300');
                    signOutBtn.classList.add('bg-primary/20', 'border-primary/40', 'text-primary');
                    
                    signInBtn.classList.remove('bg-primary/20', 'border-primary/40', 'text-primary');
                    signInBtn.classList.add('bg-gray-800', 'border-gray-700', 'text-gray-300');
                }
            }
            
            function resetActionButtons() {
                selectedAction = 'signin';
                selectAction('signin');
            }
            
            // Form validation and submission (improved)
            document.getElementById('manual-form').addEventListener('submit', handleFormSubmit);
            document.getElementById('student-id').addEventListener('input', hideInputError);
            
            function handleFormSubmit(e) {
                e.preventDefault();
                
                const studentId = document.getElementById('student-id').value.trim();
                
                if (!isValidStudentId(studentId)) {
                    showInputError();
                    return;
                }
                
                // Process manual entry
                closeModal();
                const toastType = selectedAction === 'signin' ? 'success' : 'signout';
                showToast(toastType, studentId);
            }
            
            function isValidStudentId(id) {
                return id.length >= 3 && id.length <= 20 && /^[a-zA-Z0-9]+$/.test(id);
            }
            
            function showInputError() {
                document.getElementById('input-error').classList.remove('hidden');
                document.getElementById('student-id').classList.add('border-error');
            }
            
            function hideInputError() {
                document.getElementById('input-error').classList.add('hidden');
                document.getElementById('student-id').classList.remove('border-error');
            }
            
            // Cleanup on page unload
            window.addEventListener('beforeunload', () => {
                stopScanner();
            });
        });
    </script>